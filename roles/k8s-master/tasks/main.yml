---
# =============================================================================
# Role: k8s-master
# kubeadm init (skip kube-proxy), install Cilium via Helm
# =============================================================================

- name: Check if kubeadm has already been initialized
  stat:
    path: /etc/kubernetes/admin.conf
  register: kubeadm_init_check

- name: Create kubeadm config
  template:
    src: kubeadm-config.yml.j2
    dest: /tmp/kubeadm-config.yml
    mode: '0644'
  when: not kubeadm_init_check.stat.exists

- name: Initialize Kubernetes master
  command: kubeadm init --config /tmp/kubeadm-config.yml --upload-certs
  register: kubeadm_init
  when: not kubeadm_init_check.stat.exists

- name: Display kubeadm init output
  debug:
    var: kubeadm_init.stdout_lines
  when: kubeadm_init is changed

# --- Setup kubectl for ubuntu user ---
- name: Create .kube directory for ubuntu user
  file:
    path: /home/{{ vm_user }}/.kube
    state: directory
    owner: "{{ vm_user }}"
    group: "{{ vm_user }}"
    mode: '0755'

- name: Copy admin.conf to ubuntu user's kubeconfig
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/{{ vm_user }}/.kube/config
    remote_src: yes
    owner: "{{ vm_user }}"
    group: "{{ vm_user }}"
    mode: '0600'

# --- Install Cilium ---
- name: Add Cilium Helm repository
  command: helm repo add cilium {{ cilium_helm_repo }}
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  changed_when: false
  become_user: "{{ vm_user }}"
  become: yes

- name: Update Helm repositories
  command: helm repo update
  environment:
    KUBECONFIG: /home/{{ vm_user }}/.kube/config
  changed_when: false
  become_user: "{{ vm_user }}"
  become: yes

- name: Check if Cilium is already installed
  command: helm status cilium -n kube-system
  environment:
    KUBECONFIG: /home/{{ vm_user }}/.kube/config
  register: cilium_status
  changed_when: false
  failed_when: false
  become_user: "{{ vm_user }}"
  become: yes

- name: Install Cilium via Helm
  command: >
    helm install cilium cilium/cilium
    --version {{ cilium_version }}
    --namespace kube-system
    --set kubeProxyReplacement=true
    --set k8sServiceHost={{ k8s_master_ip }}
    --set k8sServicePort=6443
    --set tunnel=vxlan
    --set bpf.masquerade=true
    --set ipam.operator.clusterPoolIPv4PodCIDRList={{ k8s_pod_cidr }}
    --set operator.replicas=1
  environment:
    KUBECONFIG: /home/{{ vm_user }}/.kube/config
  when: cilium_status.rc != 0
  become_user: "{{ vm_user }}"
  become: yes

- name: Wait for Cilium pods to be ready
  command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=cilium-agent -n kube-system --timeout=300s
  environment:
    KUBECONFIG: /home/{{ vm_user }}/.kube/config
  retries: 3
  delay: 30
  register: cilium_wait
  until: cilium_wait.rc == 0
  become_user: "{{ vm_user }}"
  become: yes

- name: Wait for CoreDNS to be ready
  command: kubectl wait --for=condition=ready pod -l k8s-app=kube-dns -n kube-system --timeout=300s
  environment:
    KUBECONFIG: /home/{{ vm_user }}/.kube/config
  retries: 3
  delay: 15
  register: coredns_wait
  until: coredns_wait.rc == 0
  become_user: "{{ vm_user }}"
  become: yes

# --- Generate join command ---
- name: Generate kubeadm join command
  command: kubeadm token create --print-join-command --ttl 2h
  register: join_command_raw
  changed_when: false

- name: Set join command fact
  set_fact:
    k8s_join_command: "{{ join_command_raw.stdout }}"

# --- Copy kubeconfig to host ---
- name: Fetch kubeconfig to host
  fetch:
    src: /etc/kubernetes/admin.conf
    dest: "{{ kubeconfig_local_path }}"
    flat: yes

- name: Display cluster status
  command: kubectl get nodes -o wide
  environment:
    KUBECONFIG: /home/{{ vm_user }}/.kube/config
  register: nodes_status
  changed_when: false
  become_user: "{{ vm_user }}"
  become: yes

- name: Show cluster status
  debug:
    var: nodes_status.stdout_lines
